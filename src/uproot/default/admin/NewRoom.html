{% extends "Admin.html" %}

{% block title %}

{% translate %}
New room/lobby
{% endtranslate %}

{% endblock title %}


{% block main %}

<div class="alert bg-uproot-light border-uproot-light mb-4">
    <p>
        {% translate %}Please note that a room/lobby created this way will disappear when you reset the database.{% endtranslate %}
    </p>
    <p class="mb-0">
        {% translate %}Only rooms/lobbies defined in your <code class="fs-6">main.py</code> file will be automatically recreated after a database reset.{% endtranslate %}
    </p>

</div>

<div class="form-floating">
    <input type="text" class="form-control" id="name" name="name"
        placeholder="{% translate %}Room name{% endtranslate %}" required>
    <label for="name" class="form-label">{% translate %}Room name{% endtranslate %}</label>
    <small class="d-block form-text pt-2 text-muted">
        {% translate %}
        The room name must be a valid Python identifier.
        For instance, it must not start with a digit, it must not contain spaces, and it must not contain hyphens.
        {% endtranslate %}
    </small>
</div>

<div class="mt-4" x-data="{useConfig: false, useSession: false}">
    <div class="form-check" x-show="!useSession">
        <input class="form-check-input" type="checkbox" id="use_config" name="use_config" value="1"
            @click="useConfig = !useConfig">
        <label for="use_config">{% translate %}Associate with a particular config{% endtranslate %}</label>
    </div>
    <div x-show="useConfig">
        <div class="form-floating mt-3" id="config-select"></div>

        <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="start" name="start" value="1" checked>
            <label for="start">{% translate %}Start this config immediately{% endtranslate %}</label>
        </div>
    </div>

    <div class="form-check mt-3" x-show="!useConfig">
        <input class="form-check-input" type="checkbox" id="use_session" name="use_session" value="1"
            @click="useSession = !useSession">
        <label for="use_session">{% translate %}Associate with an existing session{% endtranslate %}</label>
    </div>
    <div class="form-floating mt-3" x-show="useSession">
        <input class="form-control" type="text" id="sname" name="sname" placeholder="Session name">
        <label for="sname">{% translate %}Session name{% endtranslate %}</label>
        <small class="d-block form-text pt-2 text-muted">
            {% translate %}
            The session must exist.
            This can be used to add players to an existing session.
            {% endtranslate %}
        </small>
    </div>
</div>

<div x-data="{useLabels: false}">
    <div class="form-check mt-3">
        <input class="form-check-input" type="checkbox" id="use_labels" name="use_labels" value="1"
            @click="useLabels = !useLabels">
        <label for="use_labels">Use labels/Access Codes</label>
    </div>
    <div class="form-floating mt-3" x-show="useLabels">
        <textarea class="form-control h-auto" id="labels" rows="10" name="labels" placeholder="Labels"></textarea>
        <label for="labels">Labels</label>
        <small class="d-block form-text pt-2 text-muted">
            {% translate %}
            Insert one label per line of text. Each label must be no longer than 128 characters.
            Labels restrict room access to players with matching labels.
            {% endtranslate %}
        </small>
    </div>
</div>

<div x-data="{useCapacity: false}">
    <div class="form-check mt-3">
        <input class="form-check-input" type="checkbox" id="use_capacity" name="use_capacity" value="1"
            @click="useCapacity = !useCapacity">
        <label for="use_capacity">Limit capacity of resulting session</label>
    </div>
    <div class="form-floating mt-3" x-show="useCapacity">
        <input type="number" class="form-control w-auto" id="capacity" name="capacity"
            placeholder="{% translate %}Maximum players{% endtranslate %}" min="1" value="1">
        <label for="capacity" class="form-label">{% translate %}Maximum players{% endtranslate %}</label>
    </div>
</div>

<button type="button" class="btn btn-uproot mt-4" onclick="createRoom()">Create room</button>

{% endblock main %}


{% block late %}

<script>
    uproot.onStart(() => {
        renderConfigsApps(uproot.vars.configs, "config-select");
    });

    function createRoom() {
        let nameValid = true, labelsValid = true, snameValid = true;

        // Validate room name
        nameValid = uproot.isPythonIdentifier(I("name").value);
        nameValid2 = !uproot.vars.rooms_available.includes(I("name").value);

        // Validate labels if used
        if (I("use_labels").checked) {
            const labels = I("labels").value.split("\n").map((a) => a.trim()).filter(l => l.length > 0);
            labelsValid = labels.every(label => label.length <= 128);
        }

        // Validate session name if used
        if (I("use_session").checked && I("sname").value.trim() !== "") {
            snameValid = uproot.vars.sessions_available.includes(I("sname").value);
        }

        if (!nameValid) {
            uproot.error(_("The room name you entered is invalid."));
        }
        else if (!nameValid) {
            uproot.error(_("The room name you entered already exists."));
        }
        else if (!labelsValid) {
            uproot.error(_("One or more labels exceed the maximum length of 128 characters."));
        }
        else if (!snameValid) {
            uproot.error(_("The session you entered does not exist."));
        }
        else {
            document.forms[0].submit();
        }
    }
</script>

{% endblock late %}
