{% extends "Admin.html" %}

{% block title %}

{% translate %}
New room
{% endtranslate %}

{% endblock title %}


{% block main %}

<div class="alert bg-uproot-light border-uproot-light mb-4">
    <p>
        {% translate %}Please note that a room created this way will disappear when you reset the database.{% endtranslate %}
    </p>
    <p class="mb-0">
        {% translate %}Only rooms defined in your <code class="fs-6">main.py</code> file will be automatically recreated after a database reset.{% endtranslate %}
    </p>

</div>

<div class="form-floating">
    <input type="text" class="form-control" id="name" name="name"
        placeholder="{% translate %}Room name{% endtranslate %}" required>
    <label for="name" class="form-label">{% translate %}Room name{% endtranslate %}</label>
    <small class="d-block form-text pt-2 text-muted">
        {% translate %}
        The room name must only use the following characters: <code>A-Za-z0-9-._</code>
        {% endtranslate %}
    </small>
</div>

<div class="mt-4" x-data="{useConfig: false, useSession: false}">
    <div class="form-check" x-show="!useSession">
        <input class="form-check-input" type="checkbox" id="use_config"
            @click="useConfig = !useConfig; if (!useConfig) { I('config').value = ''; }">
        <label for="use_config">{% translate %}Associate with a particular config{% endtranslate %}</label>
    </div>
    <div x-show="useConfig">
        <div class="form-floating mt-3" id="config-select"></div>

        <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="open" name="open" value="1" checked>
            <label for="open">{% translate %}Start this config immediately{% endtranslate %}</label>
        </div>
    </div>

    <div class="form-check mt-3" x-show="!useConfig">
        <input class="form-check-input" type="checkbox" id="use_session"
            @click="useSession = !useSession; if (!useSession) { I('sname').value = ''; }">
        <label for="use_session">{% translate %}Associate with an existing session{% endtranslate %}</label>
    </div>
    <div class="form-floating mt-3" x-show="useSession">
        <input class="form-control" type="text" id="sname" name="sname" placeholder="Session name">
        <label for="sname">{% translate %}Session name{% endtranslate %}</label>
        <small class="d-block form-text pt-2 text-muted">
            {% translate %}
            The session must exist.
            This can be used to add players to an existing session.
            {% endtranslate %}
        </small>
    </div>
</div>

<div x-data="{useLabels: false}">
    <div class="form-check mt-3">
        <input class="form-check-input" type="checkbox" id="use_labels"
            @click="useLabels = !useLabels; if (!useLabels) { I('labels').value = ''; }">
        <label for="use_labels">Use labels/Access Codes</label>
    </div>
    <div class="form-floating mt-3" x-show="useLabels">
        <textarea class="form-control h-auto" id="labels" rows="10" name="labels" placeholder="Labels"></textarea>
        <label for="labels">Labels</label>
        <small class="d-block form-text pt-2 text-muted">
            {% translate %}
            Insert one label per line of text. Each label must be no longer than 128 characters and only use the following characters: <code>A-Za-z0-9-._</code> Labels restrict room access to players with matching labels.
            {% endtranslate %}
        </small>
    </div>
</div>

<div x-data="{useCapacity: false}">
    <div class="form-check mt-3">
        <input class="form-check-input" type="checkbox" id="use_capacity"
            @click="useCapacity = !useCapacity; if (!useCapacity) { I('capacity').value = ''; }">
        <label for="use_capacity">Limit capacity of resulting session</label>
    </div>
    <div class="form-floating mt-3" x-show="useCapacity">
        <input type="number" class="form-control w-auto" id="capacity" name="capacity"
            placeholder="{% translate %}Maximum players{% endtranslate %}" min="1">
        <label for="capacity" class="form-label">{% translate %}Maximum players{% endtranslate %}</label>
    </div>
</div>

<button type="button" class="btn btn-uproot mt-4" onclick="createRoom()">Create room</button>

{% endblock main %}


{% block late %}

<script>
    uproot.onStart(() => {
        renderConfigsApps(uproot.vars.configs, "config-select");
    });

    function createRoom() {
        let nameValid, nameAvailable, labelsValid = true, snameValid = true;

        // Validate room name format
        nameValid = uproot.isValidToken(I("name").value);
        // Validate room name doesn't already exist
        nameAvailable = !uproot.vars.rooms_available.includes(I("name").value);

        // Validate labels if any are entered
        const labelsValue = I("labels").value.trim();
        if (labelsValue) {
            const labels = labelsValue.split("\n").map((a) => a.trim()).filter(l => l.length > 0);
            labelsValid = labels.every(label => label.length <= 128);
        }

        // Validate session name if entered
        const snameValue = I("sname").value.trim();
        if (snameValue) {
            snameValid = uproot.vars.sessions_available.includes(snameValue);
        }

        if (!nameValid) {
            uproot.error(_("The room name you entered is invalid."));
        }
        else if (!nameAvailable) {
            uproot.error(_("The room name you entered already exists."));
        }
        else if (!labelsValid) {
            uproot.error(_("One or more labels exceed the maximum length of 128 characters."));
        }
        else if (!snameValid) {
            uproot.error(_("The session you entered does not exist."));
        }
        else {
            document.forms[0].submit();
        }
    }
</script>

{% endblock late %}
