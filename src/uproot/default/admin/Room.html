{% extends "Admin.html" %}


{% block title %}

{% translate %}
Room
{% endtranslate %}
<span class="font-monospace">{{ roomname }}</span>

{% endblock title %}


{% block head %}

<style>
    /* Color visited links so that it is clear during debuggin which participat URL one has already opened */
    .player-url:visited {
        color: var(--bs-uproot) !important;
    }
</style>

{% endblock head %}


{% block main %}

{% if room.sname is none %}

<h3 class="mb-3">{% translate %}New session{% endtranslate %}</h3>

<script>
    const defaultConfig = uproot.vars.room.config || "";
</script>

{% include "CreateSession.html" %}

<input type="hidden" name="assignees" id="assignees" value="">

<div x-data="{}">
    <div class="form-check mt-3">
        <input class="form-check-input" type="checkbox" id="nogrow" name="nogrow" value="1" checked>
        <label for="nogrow">Set room capacity to number of players</label>
        <small class="d-block form-text pt-2 text-muted">
            {% translate %}
            If this box is unchecked, the room’s capacity will not be changed. This means that new room entrants can grow the session.
            {% endtranslate %}
            {% if room.capacity is none %}
            {% translate %}
            This room’s capacity is infinite.
            {% endtranslate %}
            {% else %}
            {% translate %}
            This room’s capacity is {{ room.capacity }}.
            {% endtranslate %}
            {% endif %}
        </small>
    </div>
</div>

<button type="button" class="btn btn-uproot mt-4" onclick="createSession()">Create session</button>

<h3 class="mb-3 mt-4">{% translate %}Traces{% endtranslate %}</h3>

<h4 class="mb-3">{% translate %}Recently seen{% endtranslate %}</h4>

<p><i>n</i>&nbsp;=&nbsp;<span class="n-here">0</span></p>

<div id="recently-seen"></div>

<h4 class="mb-3">{% translate %}Not recently seen{% endtranslate %}</h4>
<div id="not-recently-seen"></div>  {# TODO #}

<script>
    const expectedLabels = uproot.vars.room.labels || [];
    const recent = 30;  // TODO: Holger, take the wheel!

    let seen = uproot.vars.online;
    let currentRecentLabels = [];

    function preSubmit() {
        I("assignees").value = JSON.stringify(currentRecentLabels);

        return true; // can add further checks here
    }

    function createTooltip(element, time) {
        try {
            if (window.bootstrap?.Tooltip) {
                return new window.bootstrap.Tooltip(element, { title: time, placement: "top" });
            } else {
                element.setAttribute("title", time);
                return null;
            }
        } catch {
            element.setAttribute("title", time);
            return null;
        }
    }

    function updateUI() {
        const now = Date.now() / 1000;
        const recentlySeenDiv = document.getElementById('recently-seen');
        const notRecentlySeenDiv = document.getElementById('not-recently-seen');

        const recentLabels = Object.keys(seen)
            .filter(label => now - seen[label] <= recent)
            .sort();

        [...document.querySelectorAll(".n-here")].forEach((el) => el.textContent = recentLabels.length);

        if (JSON.stringify(recentLabels) !== JSON.stringify(currentRecentLabels)) {
            recentlySeenDiv.querySelectorAll('.badge').forEach(element => {
                const tooltip = window.bootstrap?.Tooltip?.getInstance(element);
                if (tooltip) tooltip.dispose();
            });

            recentlySeenDiv.innerHTML = /* SAFE */ recentLabels
                .map(label => `<span class="badge bg-success me-1" data-label="${label}">${uproot.escape(label)}</span>`)
                .join('');

            recentlySeenDiv.querySelectorAll('.badge').forEach(element => {
                const label = element.getAttribute('data-label');
                const time = new Date(seen[label]).toLocaleTimeString();
                createTooltip(element, time);
            });

            currentRecentLabels = recentLabels;
        } else {
            recentlySeenDiv.querySelectorAll('.badge').forEach(element => {
                const label = element.getAttribute('data-label');
                const time = new Date(seen[label]).toLocaleTimeString();
                const tooltip = window.bootstrap?.Tooltip?.getInstance(element);
                if (tooltip) {
                    tooltip.setContent({ '.tooltip-inner': time });
                }
            });
        }

        const notRecentLabels = expectedLabels
            .filter(label => !recentLabels.includes(label))
            .sort();

        notRecentlySeenDiv.innerHTML = /* SAFE */ notRecentLabels
            .map(label => `<span class="badge bg-secondary me-1">${uproot.escape(label)}</span>`)
            .join('');
    }

    function cleanupOld() {
        const now = Date.now() / 1000;
        Object.keys(seen).forEach(label => {
            if (now - seen[label] > recent) {
                delete seen[label];
            }
        });
        updateUI();
    }

    uproot.onStart(() => {
        updateUI();

        uproot.invoke("subscribe_to_attendance", `^${uproot.vars.roomname}`);
        setInterval(cleanupOld, 1000);

        document.querySelector("label[for='nplayers']").innerHTML += /* SAFE */ " (<b>#n# recently seen</b>)".replace("#n#", "<span class='n-here'>0</span>");
    });

    uproot.onCustomEvent("Attended", (event) => {
        const label = event?.detail?.uname;
        if (!label) return;

        if (event?.detail?.online !== null) {
            seen[label] = Date.now() / 1000;
        }
        else {
            delete seen[label];
        }

        updateUI();
    });

</script>

{% else %}

<div class="row">
    <div class="col-12 col-lg-6 pb-4">
        <div class="border-uproot-light card h-100">
            <div class="bg-white border-0 card-header">
                <h4 class="border-bottom border-uproot-light fw-semibold mb-0 mt-2 pb-3">{% translate %}Existing session{% endtranslate %}</h4>
            </div>
            <div class="card-body">
                <p>{% translate %}This room is associated with session{% endtranslate %} <a class="font-monospace link-subtle" href="../../session/{{ room.sname }}/">{{ room.sname }}</a>.</p>
                <p><button type="button" class="btn btn-danger" onclick="disassociate()">{% translate %}Disassociate room and session{% endtranslate %}</button></p>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-6 pb-4">
        <div class="border-uproot-light card h-100">
            <div class="bg-white border-0 card-header">
                <h4 class="border-bottom border-uproot-light fw-semibold mb-0 mt-2 pb-3">{% translate %}Player URL{% endtranslate %}</h4>
            </div>
            <div class="card-body">
                <p>The player URL for entering this room is</p>
                <ul>
                    <li>
                        <a class="link-offset-2 link-underline-dark link-underline-opacity-25 link-underline-opacity-100-hover player-url"
                            href="../../../room/{{ roomname }}/" target="_blank">{{ root }}/room/{{ roomname }}/</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
                
<script>
    function disassociate() {
        uproot.invoke("disassociate", uproot.vars.room.name, uproot.vars.room.sname).then(() => {
            uproot.reload();
        });
    }
</script>

{% endif %}

{% endblock main %}
