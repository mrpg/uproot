{% extends "Admin.html" %}


{% block title %}

{% translate %}
Room
{% endtranslate %}
<span class="font-monospace">{{ roomname }}</span>

{% endblock title %}


{% block head %}

<style>
    /* Color visited links so that it is clear during debuggin which participat URL one has already opened */
    .player-url:visited {
        color: var(--bs-uproot) !important;
    }
</style>

{% endblock head %}


{% block main %}

{% if room.sname is none %}

<h3 class="mb-3">{% translate %}Player URL{% endtranslate %}</h3>

<p>{% translate %}Players can use the following URL for entering this room{% endtranslate %}:</p>
<ul>
    <li>
        <a class="link-offset-2 link-underline-dark link-underline-opacity-25 link-underline-opacity-100-hover player-url"
            href="../../../room/{{ roomname }}/" target="_blank">{{ root }}/room/{{ roomname }}/</a>
    </li>
</ul>

<h3 class="mb-3 mt-4">{% translate %}New session{% endtranslate %}</h3>

<script>
    const defaultConfig = uproot.vars.room.config || "";
</script>

{% include "CreateSession.html" %}

<input type="hidden" name="assignees" id="assignees" value="">

<div x-data="{}">
    <div class="form-check mt-3">
        <input class="form-check-input" type="checkbox" id="nogrow" name="nogrow" value="1" checked>
        <label for="nogrow">Set room capacity to number of players</label>
        <small class="d-block form-text pt-2 text-muted">
            {% translate %}
            If this box is unchecked, the room’s capacity will not be changed. This means that new room entrants can grow the session.
            {% endtranslate %}
            {% if room.capacity is none %}
            {% translate %}
            This room’s capacity is infinite.
            {% endtranslate %}
            {% else %}
            {% translate %}
            This room’s capacity is {{ room.capacity }}.
            {% endtranslate %}
            {% endif %}
        </small>
    </div>
</div>

<button type="button" class="btn btn-uproot mt-4" onclick="createSession()">Create session</button>

<h3 class="mb-3 mt-4">{% translate %}Labels{% endtranslate %}</h3>

<p class="text-muted">
    {% translate %}
    Ascertaining which labels are “online” is not an exact science. Instead, uproot uses various heuristics and algorithms to make a best-effort guess at which labels were “recently seen.”
    {% endtranslate %}

    {% translate %}
    Rooms without preset labels auto-assign random labels or use acceptable labels provided through <code>?label=mylabel42</code> in the room’s URL.
    {% endtranslate %}
</p>

<div class="row" style="min-height: 200px">
    <div class="col-md-6">
        <h4 class="mb-1">{% translate %}Recently seen{% endtranslate %}, <i>n</i>&nbsp;=&nbsp;<span class="n-here">0</span></h4>
        <div id="recently-seen" class="mb-4"></div>
    </div>

    <div class="col-md-6"
    {% if not room.labels %}
    hidden
    {% endif %}
    >
        <h4 class="mb-1">{% translate %}Not recently seen{% endtranslate %}</h4>
        <div id="not-recently-seen"></div>
    </div>
</div>

<script>
    const expectedLabels = uproot.vars.room.labels || [];
    const recent = 20;

    let seen = uproot.vars.online;
    let currentRecentLabels = [];

    function preSubmit() {
        I("assignees").value = JSON.stringify(currentRecentLabels);

        return true; // can add further checks here
    }

    function createTooltip(element, time) {
        try {
            if (window.bootstrap?.Tooltip) {
                return new window.bootstrap.Tooltip(element, { title: time, placement: "top" });
            } else {
                element.setAttribute("title", time);
                return null;
            }
        } catch {
            element.setAttribute("title", time);
            return null;
        }
    }

    function updateUI() {
        const now = Date.now() / 1000;
        const recentlySeenDiv = document.getElementById('recently-seen');
        const notRecentlySeenDiv = document.getElementById('not-recently-seen');

        const recentLabels = Object.keys(seen)
            .filter(label => now - seen[label] <= recent)
            .sort();

        [...document.querySelectorAll(".n-here")].forEach((el) => el.textContent = recentLabels.length);

        if (JSON.stringify(recentLabels) !== JSON.stringify(currentRecentLabels)) {
            recentlySeenDiv.querySelectorAll('.badge').forEach(element => {
                const tooltip = window.bootstrap?.Tooltip?.getInstance(element);
                if (tooltip) tooltip.dispose();
            });

            recentlySeenDiv.innerHTML = /* SAFE */ recentLabels
                .map(label => `<span class="badge bg-success me-1" data-label="${label}">${uproot.escape(label)}</span>`)
                .join('');

            recentlySeenDiv.querySelectorAll('.badge').forEach(element => {
                const label = element.getAttribute('data-label');
                const time = new Date(seen[label]).toLocaleTimeString();
                createTooltip(element, time);
            });

            currentRecentLabels = recentLabels;
        } else {
            recentlySeenDiv.querySelectorAll('.badge').forEach(element => {
                const label = element.getAttribute('data-label');
                const time = new Date(1000 * seen[label]).toLocaleTimeString();
                const tooltip = window.bootstrap?.Tooltip?.getInstance(element);
                if (tooltip) {
                    tooltip.setContent({ '.tooltip-inner': time });
                }
            });
        }

        const notRecentLabels = expectedLabels
            .filter(label => !recentLabels.includes(label))
            .sort();

        notRecentlySeenDiv.innerHTML = /* SAFE */ notRecentLabels
            .map(label => `<span class="badge bg-secondary me-1">${uproot.escape(label)}</span>`)
            .join('');
    }

    function cleanupOld() {
        const now = Date.now() / 1000;
        Object.keys(seen).forEach(label => {
            if (now - seen[label] > recent) {
                delete seen[label];
            }
        });
        updateUI();
    }

    uproot.onStart(() => {
        updateUI();

        uproot.invoke("subscribe_to_attendance", `^${uproot.vars.roomname}`);
        setInterval(cleanupOld, 1000);

        document.querySelector("label[for='nplayers']").innerHTML += /* SAFE */ " (<b>#n# recently seen</b>)".replace("#n#", "<span class='n-here'>0</span>");
    });

    uproot.onCustomEvent("Attended", (event) => {
        const label = event?.detail?.uname;
        if (!label) return;

        if (event?.detail?.online !== null) {
            seen[label] = Date.now() / 1000;
        }
        else {
            delete seen[label];
        }

        updateUI();
    });

</script>

{% else %}  {# room.sname is not none #}

<div class="row">
    <div class="col-12 col-lg-6 mb-4">
        <div class="border-uproot-light card h-100">
            <div class="bg-white border-0 card-header pb-1">
                <h4 class="border-bottom border-uproot-light fw-semibold mb-0 mt-2 pb-3">
                    {% translate %}Existing session{% endtranslate %}
                </h4>
            </div>
            <div class="card-body">
                <p class="mb-2">
                    {% translate %}This room is associated with the following session{% endtranslate %}:
                </p>
                <p class="fs-4">
                    <a class="font-monospace link-subtle" href="../../session/{{ room.sname }}/">{{ room.sname }}</a>
                </p>
                <p class="mb-1 mt-4">
                    <button type="button" class="btn btn-danger btn-sm" onclick="disassociate()">{% translate %}Dissociate room and session{% endtranslate %}</button>
                </p>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-6 mb-4">
        <div class="border-uproot-light card h-100">
            <div class="bg-white border-0 card-header pb-1">
                <h4 class="border-bottom border-uproot-light fw-semibold mb-0 mt-2 pb-3">
                    {% translate %}Associated config{% endtranslate %}
                </h4>
            </div>
            <div class="card-body">
                {% if room.config %}
                <p class="mb-2">
                    {% translate %}This room is associated with the following config{% endtranslate %}:
                </p>
                <p class="font-monospace fs-4">
                    {{ room.config }}
                </p>
                <h6 class="fw-semibold">Apps</h6>
                <p class="font-monospace mb-1">
                    {{ configs.configs[room.config] }}
                </p>
                {% else %}
                {% translate %}This room is not associated with a particular config{% endtranslate %}.
                {% endif %}
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-12 col-lg-6 mb-4">
        <div class="border-uproot-light card h-100">
            <div class="bg-white border-0 card-header pb-1">
                <h4 class="border-bottom border-uproot-light fw-semibold mb-0 mt-2 pb-3">{% translate %}Player URL{% endtranslate %}</h4>
            </div>
            <div class="card-body">
                <p>{% translate %}Players can use the following URL for entering this room{% endtranslate %}:</p>
                <ul>
                    <li>
                        <a class="link-offset-2 link-underline-dark link-underline-opacity-25 link-underline-opacity-100-hover player-url"
                            href="../../../room/{{ roomname }}/" target="_blank">{{ root }}/room/{{ roomname }}/</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-6 mb-4">
        <div class="border-uproot-light card h-100">
            <div class="bg-white border-0 card-header pb-1">
                <h4 class="border-bottom border-uproot-light fw-semibold mb-0 mt-2 pb-3">
                    {% translate %}Associated labels{% endtranslate %}
                </h4>
            </div>
            <div class="card-body">
                {% if room.labels %}
                <p class="mb-2">
                    {% translate %}This room is associated with the following labels{% endtranslate %}:
                </p>
                <p class="font-monospace">
                    {% for label in room.labels %}
                    {{ label }}{% if not loop.last %}<span class="text-body-tertiary"> |</span>{% endif %}
                    {% endfor %}
                </p>
                {% else %}
                {% translate %}This room is not associated with any labels{% endtranslate %}.
                {% endif %}

            </div>
        </div>
    </div>
</div>

<script>
    function disassociate() {
        uproot.invoke("disassociate", uproot.vars.room.name, uproot.vars.room.sname).then(() => {
            uproot.reload();
        });
    }
</script>

{% endif %}

{% endblock main %}
