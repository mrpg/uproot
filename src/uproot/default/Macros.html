{% macro error(field) %}
    {% if field.errors %}
        <div class="card mt-2 text-bg-danger border-danger" role="alert">
            {% for error in field.errors %}
                <div class="card-body pb-1 pt-1">
                    <small>{{ error }}</small>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endmacro %}


{% macro error_class(field) %}{% if field.errors %}alert alert-danger text-black{% endif %}{% endmacro %}


{% macro likert_matrix() %}
    {% set field0 = varargs.0 %}
    <table class="table w-100">
        <tr>
            <td class="border-0"></td>
            <td colspan="{{ field0.max - field0.min + 1 }}">
                <div class="d-flex justify-content-between">
                    <div>{{ field0.label_min }}</div>
                    <div>{{ field0.label_max }}</div>
                </div>
            </td>
        </tr>
        <tr>
            <td></td>
            {% for subfield in field0 %}
                <td>
                    {% if field0.render_kw and field0.render_kw.get("class") %}
                        <div class="{{ field0.render_kw.get('class') }}">
                    {% else %}
                        <div class="text-body-tertiary text-center">
                    {% endif %}
                    {{ subfield.label(class_="form-check-label me-0") | replace("-", "−") }}
                    </div>
                </td>
            {% endfor %}
        </tr>
        {% for field_ in varargs %}
            <tr>
                <td class="ps-0">
                    {{ field_.label(class_="form-label uproot-form-label") }}
                    {% if field_.description %}
                        <small class="form-text text-body-secondary uproot-form-description">{{ field_.description | safe }}</small>
                    {% endif %}
                </td>
                {% for subfield in field_ %}
                    <td class="text-center likert-cell" onclick="this.children[0].click()">
                        {{ subfield(class_="form-check-input") }}
                    </td>
                {% endfor %}
            </tr>
        {% endfor %}
    </table>
{% endmacro %}


{% macro field(field) %}
    {% set ADDON_START = (field.addon_start is defined and field.addon_start is not none) %}
    {% set ADDON_END = (field.addon_end is defined and field.addon_end is not none) %}
    {% set ADDON_PRESENT = ADDON_START or ADDON_END %}
    <div class="uproot-form-group {{ field.class_wrapper | default('', true) }}">
        <div class="{{ error_class(field) }}">
        {% if field.type == "BooleanField" %}
            <div class="form-check">
                {% set class_list = ["form-check-input"] %}
                {% if field.render_kw and field.render_kw.get("class") %}
                    {% set _ = class_list.append(field.render_kw.get("class")) %}
                {% endif %}
                {{ field(class_=" ".join(class_list)) | safe }}
                {{ field.label(class_="form-check-label uproot-form-label") }}
                {% if field.description %}
                    <small class="form-text uproot-form-description">{{ field.description | safe }}</small>
                {% endif %}
            </div>
        {% elif field.type == "DecimalRangeField" %}
            {{ field.label(class_="form-label uproot-form-label") }}
            {% set class_list = ["form-range"] %}
            {% if field.render_kw and field.render_kw.get("class") %}
                {% set _ = class_list.append(field.render_kw.get("class")) %}
            {% endif %}
            {% if field.__module__ == "uproot.fields" and not field.anchoring %}
                {% set _ = class_list.append("without-anchoring") %}
            {% endif %}
            <div class="align-items-center d-flex">
                {% if field.label_min != "" %}
                    <div class="flex-shrink-0">
                        {% if not field.hide_popover %}<div class="uproot-slider-popover-spacer"></div>{% endif %}
                        <div class="me-3 text-end uproot-slider-label-min" data-raw="{{ field.validators[1].min }}">{{ field.label_min }}</div>
                    </div>
                {% endif %}
                <div class="{% if not field.hide_popover %}uproot-slider-popover-wrapper{% else %}flex-grow-1{% endif %}">
                    {% if not field.hide_popover %}
                    <div class="uproot-slider-popover-container"></div>
                    {% endif %}
                    {{ field(class_=" ".join(class_list)) | safe }}
                </div>
                {% if field.label_max != "" %}
                    <div class="flex-shrink-0">
                        {% if not field.hide_popover %}<div class="uproot-slider-popover-spacer"></div>{% endif %}
                        <div class="ms-3 text-start uproot-slider-label-max" data-raw="{{ field.validators[1].max }}">{{ field.label_max }}</div>
                    </div>
                {% endif %}
            </div>
            {% if field.description %}
                <small class="form-text uproot-form-description">{{ field.description | safe }}</small>
            {% endif %}
        {% elif field.type == "EmailField" %}
            {{ field.label(class_="form-label uproot-form-label") }}
            <div {% if field.label_floating is defined and field.label_floating is not none %}class="form-floating"{% endif %}>
                {% set class_list = ["form-control"] %}
                {% if field.render_kw and field.render_kw.get("class") %}
                    {% set _ = class_list.append(field.render_kw.get("class")) %}
                {% endif %}
                {% if field.label_floating is defined and field.label_floating is not none %}
                    {{ field(class_=" ".join(class_list), placeholder="e-mail") | safe }}
                    <label class="text-body-tertiary bg-transparent" for="{{ field.name }}">{{ field.label_floating }}</label>
                {% else %}
                    {{ field(class_=" ".join(class_list)) | safe }}
                {% endif %}
            </div>
            {% if field.description %}
                <small class="form-text mt-2 uproot-form-description">{{ field.description | safe }}</small>
            {% endif %}
        {% elif field.type == "LikertField" %}
            {{ field.label(class_="form-label uproot-form-label") }}
            <table class="table w-100">
                <tr>
                    <td class="w-10"></td>
                    {% for subfield in field %}
                        <td class="text-center w-auto">
                            {% if field.render_kw and field.render_kw.get("class") %}
                                <div class="{{ field.render_kw.get('class') }}">
                            {% else %}
                                <div class="text-body-tertiary">
                            {% endif %}
                                {{ subfield.label(class_="form-check-label me-0") | replace("-", "−") }}
                            </div>
                        </td>
                    {% endfor %}
                    <td class="w-10"></td>
                </tr>
                <tr>
                    <td class="text-end pe-3 ps-0">{{ field.label_min }}</td>
                    {% for subfield in field %}
                        <td class="text-center likert-cell" onclick="this.children[0].click()">
                            {{ subfield(class_="form-check-input") }}
                        </td>
                    {% endfor %}
                    <td class="text-start pe-0 ps-3">{{ field.label_max }}</td>
                </tr>
            </table>
            {% if field.description %}
                <small class="form-text uproot-form-description">{{ field.description | safe }}</small>
            {% endif %}
        {% elif field.type == "RadioField" %}
            {{ field.label(class_="form-label uproot-form-label") }}
            {% for subfield in field %}
                {% set div_class_list = ["form-check"] %}
                {% if field.render_kw and field.render_kw.get("class") %}
                    {% set _ = div_class_list.append(field.render_kw.get("class")) %}
                {% endif %}
                <div class="{{ ' '.join(div_class_list) }}">
                    {{ subfield(class_="form-check-input") }}
                    {{ subfield.label(class_="form-check-label") }}
                </div>
            {% endfor %}
            {% if field.description %}
                <small class="form-text mt-2 uproot-form-description">{{ field.description | safe }}</small>
            {% endif %}
        {% elif field.type == "BoundedChoiceField" %}
            {{ field.label(class_="form-label uproot-form-label") }}
            <input type="hidden" name="{{ field.name }}" value="">
            <div class="uproot-bounded-choice" data-bounded-min="{{ field.bounded_min }}" data-bounded-max="{{ field.bounded_max if field.bounded_max is not none else '' }}">
            {% for subfield in field %}
                {% set div_class_list = ["form-check"] %}
                {% if field.render_kw and field.render_kw.get("class") %}
                    {% set _ = div_class_list.append(field.render_kw.get("class")) %}
                {% endif %}
                <div class="{{ ' '.join(div_class_list) }}">
                    <input type="checkbox" class="form-check-input" id="{{ subfield.id }}" name="{{ field.name }}" value="{{ subfield.data }}"{% if field.data and subfield.data in field.data %} checked{% endif %}>
                    {{ subfield.label(class_="form-check-label") }}
                </div>
            {% endfor %}
            </div>
            {% if field.description %}
                <small class="form-text mt-2 uproot-form-description">{{ field.description | safe }}</small>
            {% endif %}
        {% elif field.type == "SelectField" %}
            {{ field.label(class_="form-label uproot-form-label") }}
            {% set class_list = ["form-select"] %}
            {% if field.render_kw and field.render_kw.get("class") %}
                {% set _ = class_list.append(field.render_kw.get("class")) %}
            {% endif %}
            {{ field(class_=" ".join(class_list)) | safe }}
            {% if field.description %}
                <small class="form-text mt-2 uproot-form-description">{{ field.description | safe }}</small>
            {% endif %}
        {% elif field.type == "IBANField" or field.type == "StringField" or field.type == "TextAreaField" %}
            {{ field.label(class_="form-label uproot-form-label") }}
            {% if ADDON_PRESENT %}
                <div class="input-group">
            {% endif %}
                {% if ADDON_START %}
                    <span class="input-group-text {{ field.class_addon_start }}">{{ field.addon_start }}</span>
                {% endif %}
                {% if field.label_floating is defined and field.label_floating is not none %}<div class="form-floating">{% endif %}
                    {% set class_list = ["form-control"] %}
                    {% if field.render_kw and field.render_kw.get("class") %}
                        {% set _ = class_list.append(field.render_kw.get("class")) %}
                    {% endif %}
                    {% if field.label_floating is defined and field.label_floating is not none %}
                        {{ field(class_=" ".join(class_list), placeholder="text") | safe }}
                        <label class="text-body-tertiary bg-transparent" for="{{ field.name }}">{{ field.label_floating }}</label>
                    {% else %}
                        {{ field(class_=" ".join(class_list)) | safe }}
                    {% endif %}
                {% if field.label_floating is defined and field.label_floating is not none %}</div>{% endif %}
                {% if ADDON_END %}
                    <span class="input-group-text {{ field.class_addon_end }}">{{ field.addon_end }}</span>
                {% endif %}
            {% if ADDON_PRESENT %}
                </div>
            {% endif %}
            {% if field.description %}
                <small class="form-text mt-2 uproot-form-description">{{ field.description | safe }}</small>
            {% endif %}
        {% else %}
            {# DateField, FileField, IntegerField, DecimalField #}
            {{ field.label(class_="form-label uproot-form-label") }}
            {% set class_list = ["form-control"] %}
            {% if field.render_kw and field.render_kw.get("class") %}
                {% set _ = class_list.append(field.render_kw.get("class")) %}
            {% endif %}
            {% if ADDON_PRESENT %}
                <div class="input-group">
            {% endif %}
                {% if ADDON_START %}
                    <span class="input-group-text {{ field.class_addon_start }}">{{ field.addon_start }}</span>
                {% endif %}
                {{ field(class_=" ".join(class_list)) | safe }}
                {% if ADDON_END %}
                    <span class="input-group-text {{ field.class_addon_end }}">{{ field.addon_end }}</span>
                {% endif %}
            {% if ADDON_PRESENT %}
                </div>
            {% endif %}
            {% if field.description %}
                <small class="form-text mt-2 uproot-form-description">{{ field.description | safe }}</small>
            {% endif %}
        {% endif %}
        {{ error(field) }}
        </div>
    </div>
{% endmacro %}


{% macro fields() %}
    {% for field_ in form %}
        {{ field(field_) }}
    {% endfor %}
{% endmacro %}


{% macro errors() %}
    {% for field_ in form %}
        <div class="uproot-form-group {{ error_class(field_) }}">
            {{ error(field_) }}
        </div>
    {% endfor %}
{% endmacro %}


{% macro chat(chatid) %}
    {% with chat=chatid %}
        {% include "Chat.html" %}
    {% endwith %}
{% endmacro %}


{# Reminder for potential filter: {{ x | default("") }} #}
